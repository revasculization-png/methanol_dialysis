<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VGHTPE PCC (Dr. Ho Yang)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 手機版優先設計 (Mobile First) */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            color: #333; 
            padding: 10px; 
            margin: 0;
            line-height: 1.4;
            -webkit-text-size-adjust: 100%;
        }
        
        .container { 
            max-width: 650px; 
            margin: 0 auto; 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }

        /* Header */
        .header-section {
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        /* Logo 樣式 */
        .logo-img { 
            height: 60px; /* Logo 高度固定 60px */
            width: auto; 
            display: block;
        }

        .title-text { text-align: left; }
        .title-text h1 { font-size: 1.35rem; font-weight: 800; color: #2c3e50; margin: 0; line-height: 1.2; }
        .title-text span { display: block; font-size: 0.85rem; font-weight: normal; color: #7f8c8d; margin-top: 3px; }
        
        h2 { 
            font-size: 1rem; 
            color: #1f618d; 
            margin-top: 25px; 
            margin-bottom: 10px; 
            border-left: 4px solid #1f618d; 
            padding-left: 8px; 
            background-color: #eaf2f8; 
            padding: 6px 8px; 
            border-radius: 0 4px 4px 0; 
        }
        
        /* Grid */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.85rem; font-weight: 600; margin-bottom: 3px; color: #555; }
        input, select { 
            padding: 9px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; 
            text-align: center; background-color: #fff; width: 100%; box-sizing: border-box; 
        }
        input[readonly], .fixed-value-display { background-color: #f1f3f5; color: #666; border: 1px solid #dee2e6; }
        .fixed-value-display { padding: 9px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 16px; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #f8f9fa; cursor: pointer; font-weight: 600; color: #7f8c8d; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: #3498db; color: white; }
        .tab-content { display: none; padding: 15px; background: #fdfefe; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; }
        .tab-content.active { display: block; }

        .radio-group { display: flex; gap: 15px; justify-content: center; background: #f0f3f4; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
        .radio-group label { margin: 0; display: flex; align-items: center; gap: 4px; font-size: 0.9rem;}
        
        /* Result */
        .result-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .result-card { 
            background: #e8f8f5; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #d1f2eb; 
            text-align: center; 
        }
        .result-title { font-size: 0.9rem; font-weight: bold; color: #16a085; margin-bottom: 5px; border-bottom: 1px solid #a2d9ce; padding-bottom: 5px; }
        .time-val { font-size: 1.6rem; font-weight: bold; color: #c0392b; }
        .time-unit { font-size: 0.9rem; color: #c0392b; }
        
        /* Button */
        .btn-calc { 
            width: 100%; padding: 12px; background-color: #2980b9; color: white; border: none; 
            border-radius: 8px; font-size: 1.1rem; font-weight: bold; margin-top: 20px; cursor: pointer;
        }
        .btn-calc:active { transform: scale(0.98); }

        /* Measured Data */
        .measured-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .measured-row input { flex: 1; }
        .remove-btn { color: #e74c3c; font-weight: bold; padding: 0 8px; font-size: 1.2rem; cursor: pointer;}

        /* Chart */
        .chart-wrapper { margin-top: 20px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        
        .custom-legend { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .legend-item { 
            font-size: 0.85rem; padding: 4px 10px; border-radius: 15px; background: #fff; 
            border: 1px solid #ddd; display: flex; align-items: center; cursor: pointer; user-select: none;
        }
        .legend-item input { width: auto; margin-right: 6px; transform: scale(1.2); cursor: pointer; }
        .color-box { width: 12px; height: 12px; display: inline-block; margin-right: 6px; border-radius: 2px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; min-width: 400px; }
        th, td { border: 1px solid #e1e4e8; padding: 8px; text-align: center; }
        th { background-color: #34495e; color: white; font-size: 0.9rem; }
        .safe-zone { background-color: #d4efdf !important; color: #145a32; font-weight: bold; }
        .checkmark { display: inline-block; font-size: 1rem; margin-left: 2px;}

        /* Footer */
        .footer { margin-top: 30px; font-size: 0.8rem; color: #666; border-top: 1px solid #eee; padding-top: 15px; text-align: left; }
        .footer .ref-title { font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; color: #333; text-align: center; }
        .footer a { color: #555; text-decoration: none; display: block; margin-bottom: 12px; line-height: 1.4; padding-left: 18px; text-indent: -18px; }
        .footer a:hover { text-decoration: underline; color: #2980b9; }
        .footer .copyright { text-align: center; margin-top: 25px; color: #aaa; font-size: 0.75rem; }
        
        .sub-section { display: none; }
        .sub-section.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <img src="logo.jpg" alt="Logo" class="logo-img">
        
        <div class="title-text">
            <h1>甲醇中毒透析治療計算機</h1>
            <span>VGHTPE PCC (Dr. Ho Yang)</span>
        </div>
    </div>

    <h2>1. 病人資料 (計算 Vd)</h2>
    <div class="grid-box">
        <div class="input-group">
            <label>性別</label>
            <select id="sex" onchange="updateVdAndEst()">
                <option value="male">男</option>
                <option value="female" selected>女</option>
            </select>
        </div>
        <div class="input-group">
            <label>年齡</label>
            <input type="number" id="age" value="24" onchange="updateVdAndEst()">
        </div>
        <div class="input-group">
            <label>身高 (cm)</label>
            <input type="number" id="height" value="171" onchange="updateVdAndEst()">
        </div>
        <div class="input-group">
            <label>體重 (kg)</label>
            <input type="number" id="weight" value="80" onchange="updateVdAndEst()">
        </div>
    </div>
    <div style="background:#f8f9fa; padding:8px; border-radius:6px; text-align:center; font-size:0.9rem; margin-top:5px; border:1px solid #eee;">
        Vd (Watson's): <span id="vdResult" style="color:#2980b9; font-weight:bold; font-size:1.2rem;">--</span> L
    </div>

    <h2>2. 起始甲醇濃度 (C<sub>initial</sub>)</h2>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('method1')">1. 抽血</button>
        <button class="tab-btn" onclick="switchTab('method2')">2. OG推估</button>
        <button class="tab-btn" onclick="switchTab('method3')">3. 攝入量</button>
    </div>

    <div id="method1" class="tab-content active">
        <div class="input-group">
            <label>抽血濃度 (mg/dL)</label>
            <input type="number" id="input_conc_lab" value="110" placeholder="輸入數值">
        </div>
    </div>

    <div id="method2" class="tab-content">
        <div class="radio-group">
            <label><input type="radio" name="og_mode" value="direct" checked onchange="toggleOgMode()"> 輸入OG</label>
            <label><input type="radio" name="og_mode" value="calc" onchange="toggleOgMode()"> 計算OG</label>
        </div>
        <div id="og_direct_panel" class="sub-section active">
            <div class="input-group">
                <label>Osmolality Gap</label>
                <input type="number" id="input_og_direct" value="30" oninput="calcMethod2_Direct()">
            </div>
        </div>
        <div id="og_calc_panel" class="sub-section">
            <div class="grid-box">
                <div class="input-group"><label>Na</label><input type="number" id="val_na" value="140" oninput="calcMethod2_Calc()"></div>
                <div class="input-group"><label>Glucose</label><input type="number" id="val_glu" value="100" oninput="calcMethod2_Calc()"></div>
                <div class="input-group"><label>BUN</label><input type="number" id="val_bun" value="15" oninput="calcMethod2_Calc()"></div>
                <div class="input-group"><label>Ethanol</label><input type="number" id="val_etoh" value="0" oninput="calcMethod2_Calc()"></div>
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>Measured Osm</label><input type="number" id="val_meas_osm" value="320" oninput="calcMethod2_Calc()">
            </div>
            <div style="background:#fff3e0; padding:8px; border-radius:5px; margin-top:10px; text-align:center; font-size:0.85rem;">
                Calc Osm: <span id="disp_calc_osm">--</span> <br> Gap: <span id="disp_og_gap" style="font-weight:bold; color:#e67e22;">--</span>
            </div>
        </div>
        <div class="result-card" style="margin-top:10px; padding:10px; background:#fff;">
            估計濃度: <span id="res_method2" style="font-size:1.2rem; color:#e67e22;">--</span> mg/dL
        </div>
    </div>

    <div id="method3" class="tab-content">
        <div class="grid-box">
            <div class="input-group"><label>體積 (mL)</label><input type="number" id="input_vol" value="100" oninput="calcMethod3()"></div>
            <div class="input-group"><label>濃度 (%)</label><input type="number" id="input_percent" value="95" oninput="calcMethod3()"></div>
        </div>
        <div class="result-card" style="margin-top:10px; padding:10px; background:#fff;">
            估計濃度: <span id="res_method3" style="font-size:1.2rem; color:#e67e22;">--</span> mg/dL
        </div>
    </div>

    <div style="background:#fefefe; border:1px solid #ddd; border-radius:10px; padding:15px; margin-top:20px;">
        <h2 style="margin-top:0;">3a. IHD 參數</h2>
        <div class="input-group" style="margin-bottom:10px;">
            <label>透析器型號 (選擇帶入 KoA)</label>
            <select id="dialyzer_select" onchange="updateKoA()">
                <option value="1292">FX80 (KoA: 1292)</option>
                <option value="781">F7 (KoA: 781)</option>
                <option value="1351">FX100 (KoA: 1351)</option>
                <option value="1584">FX120 (KoA: 1584)</option>
                <option value="1065">170H (KoA: 1065)</option>
                <option value="custom">自訂數值 (Custom)</option>
            </select>
        </div>
        <div class="grid-box">
            <div class="input-group"><label>KoA (ml/min)</label><input type="number" id="koa" value="1292" readonly></div>
            <div class="input-group"><label>Qb (ml/min)</label><input type="number" id="qb" value="250"></div>
        </div>
        <div class="input-group"><label>Qd (ml/min)</label><input type="number" id="qd" value="500"></div>
    </div>

    <div style="background:#fefefe; border:1px solid #ddd; border-radius:10px; padding:15px; margin-top:15px;">
        <h2 style="margin-top:0; border-left-color: #9b59b6; color: #8e44ad;">3b. CVVHDF 參數</h2>
        <div class="grid-box">
            <div class="input-group"><label>Qd (ml/hr)</label><input type="number" id="cvvh_qd" value="1000"></div>
            <div class="input-group"><label>Qf (ml/hr)</label><input type="number" id="cvvh_qf" value="1000"></div>
        </div>
        <div class="input-group"><label>Qnet (脫水, ml/hr)</label><input type="number" id="cvvh_qnet" value="100"></div>
        <div style="margin-top:5px; font-size:0.8rem; color:#888; text-align:center;">Effluent = Qd + Qf + Qnet (Clearance)</div>
    </div>

    <h2>4. 實測數據驗證 (選填)</h2>
    <div style="background-color: #fffde7; padding: 12px; border-radius: 8px; border: 1px solid #fff59d;">
        <div id="measured_data_container">
            <div class="measured-row">
                <input type="number" placeholder="時間(hr)" class="input-time">
                <input type="number" placeholder="濃度(mg/dL)" class="input-conc">
                <span class="remove-btn" onclick="this.parentElement.remove()">✕</span>
            </div>
        </div>
        <button onclick="addMeasuredRow()" style="background:#90a4ae; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-size:0.9rem; width:100%; margin-top:8px;">+ 新增時間點</button>
    </div>

    <button class="btn-calc" onclick="calculate()">開始計算 (Calculate)</button>

    <div id="resultsArea" style="display:none;">
        <div style="margin-top:20px; text-align:center; font-size:1.1rem; color:#2c3e50; font-weight:bold;">
            起始濃度: <span id="final_c0" style="color:#d35400;">--</span> mg/dL 
            <span style="font-size:0.9rem; color:#999; font-weight:normal;">(目標 &lt;20)</span>
        </div>

        <div class="result-container">
            <div class="result-card">
                <div class="result-title">IHD 間歇透析</div>
                <div class="time-val"><span id="time_ihd">--</span> <span class="time-unit">小時</span></div>
                <div style="font-size:0.75rem; color:#666; margin-top:5px;">
                    Urea K: <span id="k_ihd">--</span> ml/min
                </div>
            </div>
            <div class="result-card" style="border-color:#d7bde2; background:#f4ecf7;">
                <div class="result-title" style="color:#8e44ad; border-bottom-color:#d2b4de;">CVVHDF 連續透析</div>
                <div class="time-val" style="color:#8e44ad;"><span id="time_cvvh">--</span> <span class="time-unit" style="color:#8e44ad;">小時</span></div>
                <div style="font-size:0.75rem; color:#666; margin-top:5px;">
                    Effluent: <span id="k_cvvh">--</span> ml/hr
                </div>
            </div>
        </div>
        
        <h2>5. 濃度趨勢比較圖</h2>
        <div class="chart-wrapper">
            <div class="custom-legend" id="chartLegend">
                <label class="legend-item"><input type="checkbox" checked onchange="updateChartVisibility(this, 0)"> <span class="color-box" style="background:black;"></span>實測</label>
                <label class="legend-item"><input type="checkbox" checked onchange="updateChartVisibility(this, 1)"> <span class="color-box" style="background:#2980b9;"></span>IHD(動力)</label>
                <label class="legend-item"><input type="checkbox" checked onchange="updateChartVisibility(this, 2)"> <span class="color-box" style="background:#e74c3c;"></span>IHD(蔡氏)</label>
                <label class="legend-item"><input type="checkbox" checked onchange="updateChartVisibility(this, 3)"> <span class="color-box" style="background:#9b59b6;"></span>CVVHDF</label>
                <label class="legend-item"><input type="checkbox" checked onchange="updateChartVisibility(this, 4)"> <span class="color-box" style="background:#27ae60;"></span>目標</label>
            </div>
            <div class="chart-container">
                <canvas id="concentrationChart"></canvas>
            </div>
        </div>

        <h2>6. 詳細預測表</h2>
        <div style="overflow-x: auto;">
            <table id="predictionTable">
                <thead>
                    <tr>
                        <th>時間</th>
                        <th style="color:#2980b9;">IHD<br><small>(動力)</small></th>
                        <th style="color:#e74c3c;">IHD<br><small>(蔡氏)</small></th>
                        <th style="color:#8e44ad;">CVVHDF<br><small>(連續)</small></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <div class="ref-title">References</div>
        <a href="https://pubmed.ncbi.nlm.nih.gov/11703622/" target="_blank">1. Hirsch DJ, Jindal KK, Wong P, Fraser AD. A simple method to estimate the required dialysis time for cases of alcohol poisoning. Kidney Int. 2001 Nov;60(5):2021-4.</a>
        <a href="https://pubmed.ncbi.nlm.nih.gov/16129213/" target="_blank">2. Youssef GM, Hirsch DJ. Validation of a method to predict required dialysis time for cases of methanol and ethylene glycol poisoning. Am J Kidney Dis. 2005 Sep;46(3):509-11.</a>
        
        <div class="copyright">
            Clinical Decision Support Tool.<br>
            2025/2026 Version (Dr. Ho Yang)
        </div>
    </div>
</div>

<script>
    let myChart = null;
    let currentMethod = 'method1';
    const C_TARGET_FIXED = 20;
    
    let globalMaxX_IHD = 12;
    let globalMaxX_CVVH = 24;

    window.onload = function() {
        updateVdAndEst();
        toggleOgMode();
    };

    function switchTab(methodId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(methodId === 'method1') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        if(methodId === 'method2') document.querySelectorAll('.tab-btn')[1].classList.add('active');
        if(methodId === 'method3') document.querySelectorAll('.tab-btn')[2].classList.add('active');
        document.getElementById(methodId).classList.add('active');
        currentMethod = methodId;
    }

    function toggleOgMode() {
        let mode = document.querySelector('input[name="og_mode"]:checked').value;
        if(mode === 'direct') {
            document.getElementById('og_direct_panel').classList.add('active');
            document.getElementById('og_calc_panel').classList.remove('active');
            calcMethod2_Direct();
        } else {
            document.getElementById('og_direct_panel').classList.remove('active');
            document.getElementById('og_calc_panel').classList.add('active');
            calcMethod2_Calc();
        }
    }

    function updateKoA() {
        let select = document.getElementById('dialyzer_select');
        let koaInput = document.getElementById('koa');
        let val = select.value;
        if (val === 'custom') {
            koaInput.readOnly = false;
            koaInput.value = '';
            koaInput.placeholder = '輸入';
            koaInput.focus();
        } else {
            koaInput.readOnly = true;
            koaInput.value = val;
        }
    }

    function getVd(sex, age, height, weight) {
        if (sex === 'male') return 2.447 - (0.09156 * age) + (0.1074 * height) + (0.3362 * weight);
        else return -2.097 + (0.1069 * height) + (0.2466 * weight);
    }

    function updateVdAndEst() {
        let sex = document.getElementById('sex').value;
        let age = parseFloat(document.getElementById('age').value) || 0;
        let height = parseFloat(document.getElementById('height').value) || 0;
        let weight = parseFloat(document.getElementById('weight').value) || 0;
        let Vd = getVd(sex, age, height, weight);
        document.getElementById('vdResult').innerText = Vd.toFixed(2);
        toggleOgMode(); 
        calcMethod3();
    }

    function calcMethod2_Direct() {
        let og = parseFloat(document.getElementById('input_og_direct').value) || 0;
        document.getElementById('res_method2').innerText = (og * 3.2).toFixed(1);
    }

    function calcMethod2_Calc() {
        let na = parseFloat(document.getElementById('val_na').value) || 0;
        let glu = parseFloat(document.getElementById('val_glu').value) || 0;
        let bun = parseFloat(document.getElementById('val_bun').value) || 0;
        let etoh = parseFloat(document.getElementById('val_etoh').value) || 0;
        let meas = parseFloat(document.getElementById('val_meas_osm').value) || 0;
        let calcOsm = (2 * na) + (glu / 18) + (bun / 2.8) + (etoh / 4.6);
        let gap = meas - calcOsm;
        document.getElementById('disp_calc_osm').innerText = calcOsm.toFixed(1);
        document.getElementById('disp_og_gap').innerText = gap.toFixed(1);
        document.getElementById('res_method2').innerText = (gap * 3.2).toFixed(1);
    }

    function calcMethod3() {
        let vol = parseFloat(document.getElementById('input_vol').value) || 0;
        let pct = parseFloat(document.getElementById('input_percent').value) || 0;
        let Vd = parseFloat(document.getElementById('vdResult').innerText) || 35;
        let mass_g = vol * (pct/100) * 0.7915;
        document.getElementById('res_method3').innerText = ((mass_g / Vd) * 100).toFixed(1);
    }

    function addMeasuredRow() {
        let div = document.createElement('div');
        div.className = 'measured-row';
        div.innerHTML = `
            <input type="number" placeholder="時(hr)" class="input-time">
            <input type="number" placeholder="濃(mg/dL)" class="input-conc">
            <span class="remove-btn" onclick="this.parentElement.remove()">✕</span>
        `;
        document.getElementById('measured_data_container').appendChild(div);
    }

    function calculateClearanceIHD(KoA, Qb, Qd) {
        if (Qb === Qd) return Qb * (KoA / (KoA + Qb));
        let Z = (KoA * (1 - (Qb/Qd))) / Qb;
        let ez = Math.exp(Z);
        return Qb * (ez - 1) / (ez - (Qb/Qd));
    }

    function calculate() {
        let C0 = 0;
        if(currentMethod === 'method1') C0 = parseFloat(document.getElementById('input_conc_lab').value);
        else if(currentMethod === 'method2') C0 = parseFloat(document.getElementById('res_method2').innerText);
        else if(currentMethod === 'method3') C0 = parseFloat(document.getElementById('res_method3').innerText);

        if(isNaN(C0) || C0 <= 0) { alert("請確認起始濃度！"); return; }
        document.getElementById('final_c0').innerText = C0.toFixed(1);

        let Vd = parseFloat(document.getElementById('vdResult').innerText);
        let C_target = C_TARGET_FIXED;

        // 2. IHD Calculation
        let KoA = parseFloat(document.getElementById('koa').value);
        let Qb = parseFloat(document.getElementById('qb').value);
        let Qd = parseFloat(document.getElementById('qd').value);
        let K_urea_ihd = calculateClearanceIHD(KoA, Qb, Qd);
        let K_meth_ihd = K_urea_ihd * 0.8;
        
        let K_L_hr_ihd = K_meth_ihd * 60 / 1000;
        let time_ihd = (Vd / K_L_hr_ihd) * Math.log(C0 / C_target);
        if (time_ihd < 0) time_ihd = 0;

        document.getElementById('time_ihd').innerText = time_ihd.toFixed(2);
        document.getElementById('k_ihd').innerText = K_urea_ihd.toFixed(0);

        // 3. CVVHDF Calculation
        let c_qd = parseFloat(document.getElementById('cvvh_qd').value) || 0;
        let c_qf = parseFloat(document.getElementById('cvvh_qf').value) || 0;
        let c_qnet = parseFloat(document.getElementById('cvvh_qnet').value) || 0;
        let Q_eff = c_qd + c_qf + c_qnet; 
        
        let K_L_hr_cvvh = Q_eff / 1000;
        let time_cvvh = (Vd / K_L_hr_cvvh) * Math.log(C0 / C_target);
        if (time_cvvh < 0) time_cvvh = 0;

        document.getElementById('time_cvvh').innerText = time_cvvh.toFixed(1);
        document.getElementById('k_cvvh').innerText = Q_eff.toFixed(0);

        // 4. Data Generation
        let measuredPoints = [];
        document.querySelectorAll('.measured-row').forEach(row => {
            let t = parseFloat(row.querySelector('.input-time').value);
            let c = parseFloat(row.querySelector('.input-conc').value);
            if(!isNaN(t) && !isNaN(c)) measuredPoints.push({x: t, y: c});
        });

        // 決定兩種模式的最大時間 (供動態縮放)
        globalMaxX_IHD = Math.max(12, Math.ceil(time_ihd) + 4);
        globalMaxX_CVVH = Math.max(24, Math.ceil(time_cvvh) + 4); 
        // 預設產生數據到最長的時間
        let plotMaxTime = Math.max(globalMaxX_IHD, globalMaxX_CVVH);

        let tbody = document.querySelector('#predictionTable tbody');
        tbody.innerHTML = "";
        
        let d_ihd_f1 = [], d_ihd_f2 = [], d_cvvh = [], d_safe = [];
        
        for (let t = 0; t <= plotMaxTime; t += 0.5) {
            let val_ihd_f1 = C0 * Math.exp(-1 * K_L_hr_ihd * t / Vd);
            d_ihd_f1.push({x: t, y: val_ihd_f1});
            
            let val_ihd_f2 = C0 * Math.pow(0.5, t/2);
            d_ihd_f2.push({x: t, y: val_ihd_f2});
            
            let val_cvvh = C0 * Math.exp(-1 * K_L_hr_cvvh * t / Vd);
            d_cvvh.push({x: t, y: val_cvvh});
            
            d_safe.push({x: t, y: C_target});

            if (Number.isInteger(t) && t % 2 === 0) {
                let chk1 = val_ihd_f1 < C_target ? '✅' : '';
                let chk2 = val_ihd_f2 < C_target ? '✅' : '';
                let chk3 = val_cvvh < C_target ? '✅' : '';
                
                let cls1 = val_ihd_f1 < C_target ? "safe-zone" : "";
                let cls2 = val_ihd_f2 < C_target ? "safe-zone" : "";
                let cls3 = val_cvvh < C_target ? "safe-zone" : "";

                let row = `<tr>
                    <td>${t}</td>
                    <td class="${cls1}">${val_ihd_f1.toFixed(1)}${chk1}</td>
                    <td class="${cls2}">${val_ihd_f2.toFixed(1)}${chk2}</td>
                    <td class="${cls3}">${val_cvvh.toFixed(1)}${chk3}</td>
                </tr>`;
                tbody.innerHTML += row;
            }
        }

        document.getElementById('resultsArea').style.display = 'block';
        drawChart(d_ihd_f1, d_ihd_f2, d_cvvh, d_safe, measuredPoints);
        document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
    }

    // 核心功能：更新顯示狀態 + 自動縮放時間軸
    function updateChartVisibility(checkbox, index) {
        if(!myChart) return;
        
        // 1. 切換線條顯示
        if(checkbox.checked) myChart.show(index);
        else myChart.hide(index);
        
        // 2. 判斷 CVVHDF (index 3) 是否顯示，決定 X 軸長度
        let isCvvhVisible = myChart.isDatasetVisible(3);
        let newMax = isCvvhVisible ? globalMaxX_CVVH : globalMaxX_IHD;
        
        myChart.options.scales.x.max = newMax;
        myChart.update();
    }

    function drawChart(d1, d2, d3, dSafe, dMeasured) {
        const ctx = document.getElementById('concentrationChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: '實測',
                        data: dMeasured,
                        backgroundColor: 'black',
                        borderColor: 'black',
                        pointRadius: 6,
                        showLine: false,
                        type: 'scatter'
                    },
                    {
                        label: 'IHD(動力)',
                        data: d1,
                        borderColor: '#2980b9',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: 'IHD(蔡氏)',
                        data: d2,
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        tension: 0.4
                    },
                    {
                        label: 'CVVHDF',
                        data: d3,
                        borderColor: '#9b59b6',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: '目標',
                        data: dSafe,
                        borderColor: '#27ae60',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [2, 2]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            title: function(context) { return '時間: ' + context[0].parsed.x + ' h'; },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        type: 'linear', 
                        min: 0, 
                        // 初始最大值：看 CVVHDF 是否預設勾選 (HTML中預設 checked)
                        max: globalMaxX_CVVH, 
                        title: {display: true, text: '小時'} 
                    },
                    y: { beginAtZero: true, title: {display: true, text: 'mg/dL'} }
                }
            }
        });

        // 初始同步：根據 HTML Checkbox 狀態設定顯示與縮放
        let checkboxes = document.querySelectorAll('.custom-legend input');
        checkboxes.forEach((cb, i) => {
            if(!cb.checked) myChart.hide(i);
        });
        
        // 觸發一次縮放檢查
        let cvvhCheckbox = checkboxes[3]; // Index 3 is CVVHDF
        updateChartVisibility(cvvhCheckbox, 3);
    }
</script>
</body>
</html>